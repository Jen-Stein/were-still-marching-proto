<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AR.js — Final Camera Transparency Fix</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>

  <style>
    html, body { margin:0; height:100%; width:100%; overflow:hidden; background:#000; font-family:system-ui, Arial, sans-serif; }

    /* Put the camera video BEHIND… */
    video#arjs-video, video.arjs-video, video[playsinline]{
      position:fixed !important;
      top:0; left:0;
      width:100vw !important; height:100vh !important;
      object-fit:cover !important;
      z-index:0 !important;               /* BEHIND the canvas */
      background:#000;
      pointer-events:none;
      visibility:visible !important; opacity:1 !important; display:block !important;
    }

    /* …and the A-Frame WebGL canvas ABOVE (but transparent). */
    canvas.a-canvas, .a-canvas canvas{
      position:fixed !important;
      top:0; left:0;
      width:100vw !important; height:100vh !important;
      z-index:1 !important;               /* ABOVE video */
      display:block !important;
      pointer-events:none;
      background:transparent !important;  /* belt & suspenders */
    }

    a-scene{
      position:fixed !important;
      inset:0 !important;
      width:100vw !important; height:100vh !important;
      background:transparent !important;  /* make scene background transparent */
    }

    /* Start overlay */
    #gate{
      position:fixed; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      background:rgba(0,0,0,.88); color:#fff; padding:24px; text-align:center;
    }
    #gate button{
      padding:12px 22px; font-size:18px; border-radius:8px; border:none; background:#ff6b6b; color:#fff;
    }

    #status{
      position:fixed; left:8px; bottom:8px; z-index:20;
      background:rgba(0,0,0,.6); color:#0f0; padding:6px 8px; border-radius:6px; font:12px/1.3 monospace;
    }
  </style>
</head>
<body>
  <div id="gate">
    <h2>Tap Start</h2>
    <p>Allow the camera, then point at the printed marker.</p>
    <button id="start">Start</button>
  </div>
  <div id="status">loading…</div>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"

    <!-- alpha:true = transparent canvas (so the video shows through) -->
    renderer="antialias:true; alpha:true; precision:mediump"

    arjs="sourceType:webcam; facingMode:environment; detectionMode:mono; debugUIEnabled:false"
  >
    <!-- Keep barcode #5 since you confirmed detection before; switch to HIRO after camera shows -->
    <a-marker type="barcode" value="5" id="marker" emitevents="true">
      <a-box id="cube"
             position="0 1 0"
             width="2" height="2" depth="2"
             material="color:#FF00FF; shader:flat"
             visible="false"></a-box>
    </a-marker>

    <!-- To use HIRO instead, comment the barcode marker above and UNcomment this:
    <a-marker type="pattern" emitevents="true"
              url="https://raw.githubusercontent.com/jeromeetienne/AR.js/master/three.js/examples/marker-training/examples/pattern-files/pattern-hiro.patt">
      <a-box id="cube" position="0 1 0" width="2" height="2" depth="2"
             material="color:#FF00FF; shader:flat" visible="false"></a-box>
    </a-marker>
    -->

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const st    = document.getElementById('status');
    const gate  = document.getElementById('gate');
    const start = document.getElementById('start');
    const marker= document.getElementById('marker');
    const cube  = document.getElementById('cube');

    // 1) Make the canvas truly transparent (A-Frame sometimes clears to black even with alpha:true).
    document.addEventListener('DOMContentLoaded', () => {
      const tryMakeTransparent = () => {
        const scene = document.querySelector('a-scene');
        if (!scene || !scene.renderer) return false;
        // Force transparent clear (alpha = 0)
        scene.renderer.setClearColor(0x000000, 0);
        // Older three.js path:
        if (scene.renderer.getContext) {
          const gl = scene.renderer.getContext();
          try { gl.clearColor(0,0,0,0); } catch(_) {}
        }
        return true;
      };
      const t = setInterval(() => { if (tryMakeTransparent()) clearInterval(t); }, 50);
      setTimeout(() => clearInterval(t), 3000);
    });

    // 2) Find the AR.js camera <video> and force it to play + be visible.
    function getCamVideo(){
      return document.querySelector('video#arjs-video, video.arjs-video, video[playsinline]');
    }
    async function ensureCameraPlaying(){
      const v = getCamVideo();
      if (!v) return false;
      try {
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
        v.muted = true;            // allow autoplay policies
        await v.play();            // start the stream
        // Force visibility and sizing (belt & suspenders)
        Object.assign(v.style, {
          visibility:'visible', opacity:'1', display:'block',
          position:'fixed', top:'0px', left:'0px',
          width:'100vw', height:'100vh', objectFit:'cover', zIndex:'0'
        });
        return true;
      } catch(e) { console.log('Camera play failed:', e); return false; }
    }

    // 3) Watch for AR.js injecting the video; when it appears, start it.
    const mo = new MutationObserver(async () => {
      const ok = await ensureCameraPlaying();
      if (ok) st.textContent = 'Camera ready. Point at your printed marker…';
    });
    mo.observe(document.documentElement, {subtree:true, childList:true});

    // 4) Start overlay to give us a user gesture
    start.addEventListener('click', async ()=>{
      gate.style.display = 'none';
      st.textContent = 'Starting camera…';
      // Try a few times (some devices are slow)
      await ensureCameraPlaying();
      setTimeout(ensureCameraPlaying, 300);
      setTimeout(ensureCameraPlaying, 1000);
    });

    // 5) Show/hide cube on marker events
    marker.addEventListener('markerFound', ()=>{
      cube.setAttribute('visible','true');
      st.textContent = 'MARKER FOUND ✅ (you should see cube AND camera feed)';
    });
    marker.addEventListener('markerLost', ()=>{
      cube.setAttribute('visible','false');
      st.textContent = 'Point at the printed marker…';
    });
  </script>
</body>
</html>
