<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weâ€™re Still Marching â€” AR Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame (marker-based) -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    /* Fill the screen, hide scrollbars, black fallback */
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden; background:#000; font-family:Arial,sans-serif;
    }

    /* Force camera video to truly fill the screen (removes right black strip on iOS) */
    #arjs-video, video#arjs-video, video[playsinline] {
      position: fixed !important;
      top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;       /* fallback */
      height: 100svh !important;      /* modern iOS */
      object-fit: cover !important;
      z-index: 0 !important;
      background: #000 !important;
      transform: translateZ(0) scale(1.02); /* tiny overscan to kill any edge line */
      transform-origin: center center;
    }

    /* WebGL canvas on top, transparent, also overscan to match video */
    a-scene, .a-canvas, canvas {
      position: fixed !important;
      top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      height: 100svh !important;
      background: transparent !important;
      z-index: 1 !important;
      transform: translateZ(0) scale(1.02);
      transform-origin: center center;
    }

    /* Small audio unlock button (only shown if iOS blocks autoplay) */
    #soundUnlock {
      position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      z-index: 3; background: rgba(0,0,0,0.7); color:#fff; border:1px solid #fff;
      padding: 10px 14px; border-radius: 8px; font-size: 14px; display:none;
    }
  </style>
</head>
<body>

  <button id="soundUnlock">ðŸ”Š Tap to enable sound</button>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="alpha:true; antialias:true"
    arjs="sourceType: webcam; debugUIEnabled:false">

    <a-assets>
      <!-- 2D character art (GIF/PNG). If you later switch to MP4/WebM, swap to <video>. -->
      <img id="thembekaImg" src="assets/thembeka.gif" crossorigin="anonymous" alt=""/>
      <!-- Audio narration -->
      <audio id="thembekaAudio" src="assets/thembeka.mp3" preload="auto" playsinline webkit-playsinline></audio>

      <!-- (Optional later) If you export to video:
      <video id="thembekaVideo" src="assets/thembeka.mp4" loop playsinline webkit-playsinline muted></video>
      -->
    </a-assets>

    <!-- HIRO marker -->
    <a-marker preset="hiro" id="marker" emitevents="true">
      <!-- UPRIGHT + FACING CAMERA (no mirror):
           - rotation="0 180 0" points the front away; scale="-1 1 1" flips it back so text reads correctly.
           - position y raises it to hover above marker.
           - width/height: keep big but not extreme so tracking stays stable. -->
      <a-image id="thembekaPoster"
               src="#thembekaImg"
               rotation="0 180 0"
               scale="-1 1 1"
               position="0 1.6 0"
               width="5.4" height="6.2"
               material="side: double; transparent: true; alphaTest: 0.01"
               visible="false">
      </a-image>

      <!-- lights (harmless for 2D; useful if you add 3D later) -->
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Ensure the injected camera video fills the whole screen even if AR.js attaches late
    (function ensureCamVisible(){
      function styleCam(v){
        if(!v) return;
        v.id = 'arjs-video';
        Object.assign(v.style, {
          position:'fixed', top:'0', left:'0', right:'0', bottom:'0',
          width:'100vw',
          height: (CSS && CSS.supports && CSS.supports('height: 100svh')) ? '100svh' : '100vh',
          objectFit:'cover', zIndex:'0', background:'#000',
          transform:'translateZ(0) scale(1.02)',
          transformOrigin:'center center'
        });
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
        v.muted = true;
      }
      styleCam(document.querySelector('#arjs-video'));
      setTimeout(()=>styleCam(document.querySelector('#arjs-video')), 600);
      setTimeout(()=>styleCam(document.querySelector('#arjs-video')), 1200);
    })();

    const marker      = document.querySelector('#marker');
    const poster      = document.querySelector('#thembekaPoster');
    const audioEl     = document.querySelector('#thembekaAudio');
    const soundUnlock = document.querySelector('#soundUnlock');

    // Prime audio on first touch/click (iOS needs a gesture)
    let soundPrimed = false;
    function primeSound() {
      if (soundPrimed) return;
      audioEl.play().then(()=> {
        audioEl.pause();
        audioEl.currentTime = 0;
        soundPrimed = true;
        soundUnlock.style.display = 'none';
      }).catch(()=>{
        soundUnlock.style.display = 'block';
      });
    }
    document.addEventListener('touchstart', primeSound, {once:false});
    document.addEventListener('click',       primeSound, {once:false});
    soundUnlock.addEventListener('click',    primeSound);

    // Show/hide + play/pause when the marker is seen/lost
    marker.addEventListener('markerFound', () => {
      poster.setAttribute('visible','true');
      audioEl.play().catch(()=>{ soundUnlock.style.display = 'block'; });
    });

    marker.addEventListener('markerLost', () => {
      poster.setAttribute('visible','false');
      audioEl.pause();
      audioEl.currentTime = 0;
    });
  </script>
</body>
</html>
