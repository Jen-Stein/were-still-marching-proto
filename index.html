<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weâ€™re Still Marching â€” AR (GIF)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <!-- GIF shader (third-party) -->
  <script src="https://unpkg.com/aframe-gif-shader/dist/aframe-gif-shader.min.js"></script>

  <style>
    html, body {
      margin:0; padding:0; width:100%; height:100%;
      overflow:hidden; background:#000; font-family:Arial,sans-serif;
    }

    /* Force the camera video to truly fill the screen (overscan hides right-edge seam on iPhone) */
    #arjs-video, video#arjs-video, video[playsinline]{
      position:fixed !important;
      top:0 !important; left:-12px !important;
      width:calc(100vw + 24px) !important;
      height:100svh !important;            /* falls back to 100vh below */
      object-fit:cover !important;
      z-index:0 !important;
      background:#000 !important;
    }

    /* WebGL canvas on top, transparent */
    a-scene, .a-canvas, canvas{
      position:fixed !important;
      top:0 !important; left:0 !important;
      width:100vw !important; height:100svh !important;
      background:transparent !important;
      z-index:1 !important;
    }

    /* Start overlay (to unlock audio) */
    #start {
      position: fixed; inset: 0; z-index: 3;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.9); color:#fff; text-align:center; padding:24px;
    }
    #start button{
      margin-top:12px; padding:12px 18px; font-size:16px; border:0; border-radius:8px;
      background:#ff6b6b; color:#fff;
    }

    /* Fallback audio unlock if iOS still blocks */
    #soundUnlock {
      position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      z-index: 3; background: rgba(0,0,0,0.7); color:#fff; border:1px solid #fff;
      padding: 10px 14px; border-radius: 8px; font-size: 14px; display:none;
    }
  </style>
</head>
<body>

  <div id="start">
    <h2>Weâ€™re Still Marching â€” AR Prototype (GIF)</h2>
    <p>Tap Start, allow camera, then point at the printed <b>HIRO</b> marker.</p>
    <button id="startBtn">Start</button>
  </div>
  <button id="soundUnlock">ðŸ”Š Tap to enable sound</button>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="alpha:true; antialias:true"
    arjs="sourceType: webcam; debugUIEnabled:false">

    <a-assets>
      <!-- Audio narration (non-muted) -->
      <audio id="thembekaAudio"
             src="assets/thembeka.mp3"
             preload="auto"
             playsinline
             webkit-playsinline></audio>
    </a-assets>

    <!-- HIRO marker -->
    <a-marker id="marker" preset="hiro" emitevents="true"
              smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">

      <!-- Upright, facing user, hovering above marker.
           Using gif shader on a plane. 
           scale = -1 1 1 un-mirrors so text reads correctly.
           IMPORTANT: If your GIF has transparency, set transparent:true; otherwise omit it. -->
      <a-entity id="thembekaPlane"
                geometry="primitive: plane; width: 3.2; height: 4.0"
                rotation="0 0 0"
                scale="-1 1 1"
                position="0 2 0"
                visible="false"
                material="shader: gif; src: url(assets/thembeka.gif); autoplay: false; loop: true; paused: true; transparent: true;">
      </a-entity>

      <!-- optional lights (fine to keep) -->
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Keep camera video full-screen (re-apply after AR.js injects it)
    (function keepCamFull(){
      function styleCam(v){
        if(!v) return;
        v.id = 'arjs-video';
        Object.assign(v.style, {
          position:'fixed', top:'0', left:'-12px',
          width:'calc(100vw + 24px)',
          height:(CSS && CSS.supports && CSS.supports('height: 100svh')) ? '100svh' : '100vh',
          objectFit:'cover', zIndex:'0', background:'#000'
        });
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
        v.muted = true;
      }
      styleCam(document.querySelector('#arjs-video'));
      setTimeout(()=>styleCam(document.querySelector('#arjs-video')), 600);
      setTimeout(()=>styleCam(document.querySelector('#arjs-video')), 1200);
    })();

    const startUI     = document.getElementById('start');
    const startBtn    = document.getElementById('startBtn');
    const unlockBtn   = document.getElementById('soundUnlock');

    const marker      = document.getElementById('marker');
    const plane       = document.getElementById('thembekaPlane');
    const audioEl     = document.getElementById('thembekaAudio');

    let userPrimed = false;
    let markerVisible = false;
    let lostTimer = null;

    // Helper to pause/unpause GIF shader
    function setGifPaused(val){
      // Update the 'paused' prop on the material
      plane.setAttribute('material', 'paused', !!val);
    }

    // 1) Start: prime audio with a user gesture (iOS requirement)
    startBtn.addEventListener('click', async () => {
      try {
        await audioEl.play(); audioEl.pause(); audioEl.currentTime = 0;
      } catch(e){}
      userPrimed = true;
      startUI.style.display = 'none';
    });

    // 2) Show plane + play audio + unpause GIF when marker appears; reverse when lost
    marker.addEventListener('markerFound', () => {
      markerVisible = true;
      if (lostTimer) { clearTimeout(lostTimer); lostTimer = null; }

      plane.setAttribute('visible','true');
      setGifPaused(false);  // start GIF animation

      if (userPrimed) {
        audioEl.play().catch(()=>{ unlockBtn.style.display = 'block'; });
      } else {
        unlockBtn.style.display = 'block';
      }
    });

    marker.addEventListener('markerLost', () => {
      markerVisible = false;
      // Small debounce to avoid flicker stopping
      lostTimer = setTimeout(() => {
        if (!markerVisible) {
          plane.setAttribute('visible','false');
          setGifPaused(true); // pause GIF
          audioEl.pause();
          audioEl.currentTime = 0;
        }
      }, 400);
    });

    // 3) Manual unlock if iOS still blocks audio
    unlockBtn.addEventListener('click', () => {
      audioEl.play().then(()=>{ unlockBtn.style.display = 'none'; }).catch(()=>{});
    });
  </script>
</body>
</html>
