<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AR.js — Camera + Seam Fix + Tuning</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>

  <style>
    html, body { margin:0; height:100%; width:100%; overflow:hidden; background:#000; font-family:system-ui, Arial, sans-serif; }

    /* Camera BELOW canvas; slight overscan to kill right-edge line */
    video#arjs-video, video.arjs-video, video[playsinline]{
      position:fixed !important;
      top:0; left:-3px;                             /* overscan */
      width:calc(100vw + 6px) !important;           /* overscan */
      height:100vh !important;
      object-fit:cover !important;
      z-index:0 !important;                         /* BELOW */
      background:#000;
      pointer-events:none;
      visibility:visible !important; opacity:1 !important; display:block !important;
    }

    /* WebGL canvas ABOVE video — transparent because renderer alpha:true */
    canvas.a-canvas, .a-canvas canvas{
      position:fixed !important;
      top:0; left:-3px;                             /* match overscan */
      width:calc(100vw + 6px) !important;
      height:100vh !important;
      z-index:1 !important;                         /* ABOVE */
      display:block !important;
      pointer-events:none;
      background:transparent !important;
    }

    a-scene{
      position:fixed !important; inset:0 !important;
      width:100vw !important; height:100vh !important;
      background:transparent !important;
    }

    /* Start overlay to unlock camera */
    #gate{position:fixed; inset:0; z-index:10; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgba(0,0,0,.88); color:#fff; padding:24px; text-align:center}
    #gate button{padding:12px 22px; font-size:18px; border-radius:8px; border:none; background:#ff6b6b; color:#fff}

    #status{position:fixed; left:8px; bottom:8px; z-index:20; background:rgba(0,0,0,.6); color:#0f0; padding:6px 8px; border-radius:6px; font:12px/1.3 monospace}
  </style>
</head>
<body>
  <div id="gate">
    <h2>Tap Start</h2>
    <p>Allow the camera, then point at your printed marker.</p>
    <button id="start">Start</button>
  </div>
  <div id="status">loading…</div>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"

    <!-- alpha:true keeps canvas transparent so camera is visible -->
    renderer="antialias:true; alpha:true; precision:mediump"

    <!-- debugUIEnabled:true gives you threshold/blockSize sliders on screen -->
    arjs="sourceType:webcam; facingMode:environment; detectionMode:mono; debugUIEnabled:true; patternRatio:0.5"
  >
    <!-- CHOOSE ONE MARKER (uncomment only the one you are actually using) -->

    <!-- 1) BARCODE #5 (looks like a QR) — if this is what you printed, keep this one: -->
    <a-marker type="barcode" value="5" id="marker" emitevents="true">
      <a-box id="cube" position="0 1 0" width="2" height="2" depth="2"
             material="color:#FF00FF; shader:flat" visible="false"></a-box>
      <a-plane id="pad" rotation="-90 0 0" width="2" height="2"
               material="color:#FFFFFF; shader:flat; opacity:0.85" visible="false"></a-plane>
    </a-marker>

    <!-- 2) HIRO pattern — if you printed HIRO instead, comment the barcode marker above and UNcomment this:
    <a-marker type="pattern" id="marker" emitevents="true"
              url="https://raw.githubusercontent.com/jeromeetienne/AR.js/master/three.js/examples/marker-training/examples/pattern-files/pattern-hiro.patt">
      <a-box id="cube" position="0 1 0" width="2" height="2" depth="2"
             material="color:#FF00FF; shader:flat" visible="false"></a-box>
      <a-plane id="pad" rotation="-90 0 0" width="2" height="2"
               material="color:#FFFFFF; shader:flat; opacity:0.85" visible="false"></a-plane>
    </a-marker>
    -->

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const st    = document.getElementById('status');
    const gate  = document.getElementById('gate');
    const start = document.getElementById('start');

    const marker= document.getElementById('marker');
    const cube  = document.getElementById('cube');
    const pad   = document.getElementById('pad');

    // Make the THREE/WebGL clear transparent (extra safety with alpha:true)
    function forceTransparentClear(){
      const sceneEl = document.querySelector('a-scene');
      const tryIt = () => {
        if (!sceneEl || !sceneEl.renderer) return false;
        sceneEl.renderer.setClearColor(0x000000, 0);
        if (sceneEl.renderer.getContext) {
          const gl = sceneEl.renderer.getContext();
          try { gl.clearColor(0,0,0,0); } catch(_) {}
        }
        return true;
      };
      const t = setInterval(()=>{ if (tryIt()) clearInterval(t); }, 50);
      setTimeout(()=>clearInterval(t), 3000);
    }

    // Ensure the AR.js <video> is playing & visible (some phones need this nudge)
    function getCamVideo(){
      return document.querySelector('video#arjs-video, video.arjs-video, video[playsinline]');
    }
    async function ensureCameraPlaying(){
      const v = getCamVideo(); if (!v) return false;
      try {
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
        v.muted = true;  // let it autoplay after permission
        await v.play();
        Object.assign(v.style, {
          visibility:'visible', opacity:'1', display:'block',
          position:'fixed', top:'0px', left:'-3px',
          width:'calc(100vw + 6px)', height:'100vh', objectFit:'cover', zIndex:'0'
        });
        return true;
      } catch(e){ console.log('Camera play failed:', e); return false; }
    }

    // Observe DOM for injected video, then start it
    const mo = new MutationObserver(async () => {
      const ok = await ensureCameraPlaying();
      if (ok) st.textContent = 'Camera ready. Point at the printed marker…';
    });
    mo.observe(document.documentElement, {subtree:true, childList:true});

    // Start overlay
    start.addEventListener('click', async ()=>{
      gate.style.display = 'none';
      forceTransparentClear();
      st.textContent = 'Starting camera…';
      await ensureCameraPlaying();
      setTimeout(ensureCameraPlaying, 300);
      setTimeout(ensureCameraPlaying, 1000);
    });

    // Marker events
    marker.addEventListener('markerFound', ()=>{
      cube.setAttribute('visible','true');
      pad.setAttribute('visible','true');
      st.textContent = 'MARKER FOUND ✅ (adjust threshold/blockSize if it drops)';
    });
    marker.addEventListener('markerLost', ()=>{
      cube.setAttribute('visible','false');
      pad.setAttribute('visible','false');
      st.textContent = 'Point at the printed marker…';
    });
  </script>
</body>
</html>
