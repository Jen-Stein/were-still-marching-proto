<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weâ€™re Still Marching â€” AR Test (Stable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin:0; padding:0; width:100%; height:100%;
      overflow:hidden; background:#000; font-family:Arial,sans-serif;
    }
    /* Make the camera video truly cover the screen */
    #arjs-video, video#arjs-video, video[playsinline] {
      position: fixed !important;
      top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;           /* fallback */
      height: 100svh !important;          /* iOS new unit */
      object-fit: cover !important;
      z-index: 0 !important;
      background: #000 !important;
    }
    /* Put WebGL canvas above the camera */
    a-scene, .a-canvas, canvas {
      position: fixed !important;
      top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      height: 100svh !important;
      background: transparent !important;
      z-index: 1 !important;
    }
    /* Start overlay */
    #start {
      position: fixed; inset: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.9); color:#fff; z-index: 3; text-align: center; padding: 24px;
    }
    #start button {
      margin-top: 12px; padding: 12px 18px; font-size: 16px; border-radius: 8px;
      border: 0; background: #ff6b6b; color: #fff;
    }
    #soundUnlock {
      position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      z-index: 3; background: rgba(0,0,0,0.7); color:#fff; border:1px solid #fff;
      padding: 10px 14px; border-radius: 8px; font-size: 14px; display:none;
    }
  </style>
</head>
<body>

  <!-- Start (unlocks audio & primes video on iOS) -->
  <div id="start">
    <h2>Weâ€™re Still Marching â€” AR Prototype</h2>
    <p>Tap Start, allow camera, then point at the printed <b>HIRO</b> marker.</p>
    <button id="startBtn">Start</button>
  </div>

  <!-- Fallback prompt if iOS still blocks audio -->
  <button id="soundUnlock">ðŸ”Š Tap to enable sound</button>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="alpha:true; antialias:true"
    arjs="sourceType: webcam; debugUIEnabled:false">

    <a-assets>
      <!-- Video (muted, loops) -->
      <video id="thembekaVideo"
             src="assets/thembeka.mp4"
             loop
             playsinline
             webkit-playsinline
             muted></video>

      <!-- Narration (non-muted; plays after Start) -->
      <audio id="thembekaAudio"
             src="assets/thembeka.mp3"
             preload="auto"
             playsinline
             webkit-playsinline></audio>
    </a-assets>

    <!-- Marker with smoothing to reduce flicker -->
    <a-marker
      id="marker"
      preset="hiro"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">

      <!-- Upright, hovering above marker -->
      <a-video id="thembekaPoster"
               src="#thembekaVideo"
               rotation="0 180 0"
               position="0 2 0"
               width="3.2" height="4.2"
               visible="false"></a-video>

      <!-- Optional lights (fine to keep) -->
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Ensure camera video fills the screen even if AR.js injects late
    (function keepCamFull(){
      function styleCam(v){
        if(!v) return;
        v.id = 'arjs-video';
        Object.assign(v.style, {
          position:'fixed', top:'0', left:'0', width:'100vw',
          height: (CSS && CSS.supports && CSS.supports('height: 100svh')) ? '100svh' : '100vh',
          objectFit:'cover', zIndex:'0', background:'#000'
        });
        v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
        v.muted = true;
      }
      styleCam(document.querySelector('#arjs-video'));
      setTimeout(()=>styleCam(document.querySelector('#arjs-video')), 600);
      setTimeout(()=>styleCam(document.querySelector('#arjs-video')), 1200);
    })();

    const startUI     = document.getElementById('start');
    const startBtn    = document.getElementById('startBtn');
    const unlockBtn   = document.getElementById('soundUnlock');

    const marker      = document.getElementById('marker');
    const poster      = document.getElementById('thembekaPoster');
    const videoEl     = document.getElementById('thembekaVideo');
    const audioEl     = document.getElementById('thembekaAudio');

    let userPrimed = false;
    let markerVisible = false;
    let lostTimer = null;

    // 1) Start: prime media with a user gesture (iOS requirement)
    startBtn.addEventListener('click', async () => {
      try {
        // Prime video (muted) and audio (will still need play() later)
        await videoEl.play(); videoEl.pause(); videoEl.currentTime = 0;
        await audioEl.play(); audioEl.pause(); audioEl.currentTime = 0;
        userPrimed = true;
        startUI.style.display = 'none';
      } catch (e) {
        // If audio refuses, weâ€™ll show Unlock later
        userPrimed = true;
        startUI.style.display = 'none';
      }
    });

    // 2) Debounce marker events to avoid flicker freezes
    marker.addEventListener('markerFound', () => {
      markerVisible = true;
      if (lostTimer) { clearTimeout(lostTimer); lostTimer = null; }
      poster.setAttribute('visible','true');

      // Play video (muted) always allowed
      videoEl.play().catch(()=>{});

      // Try audio (needs Start tap first)
      if (userPrimed) {
        audioEl.play().catch(()=>{ unlockBtn.style.display = 'block'; });
      } else {
        unlockBtn.style.display = 'block';
      }
    });

    marker.addEventListener('markerLost', () => {
      markerVisible = false;
      // Wait 500ms before pausing in case tracking flickers briefly
      lostTimer = setTimeout(() => {
        if (!markerVisible) {
          poster.setAttribute('visible','false');
          videoEl.pause(); videoEl.currentTime = 0;
          audioEl.pause(); audioEl.currentTime = 0;
        }
      }, 500);
    });

    // 3) Manual unlock if iOS still blocks audio
    unlockBtn.addEventListener('click', () => {
      audioEl.play().then(()=>{
        unlockBtn.style.display = 'none';
      }).catch(()=>{ /* if it still fails, leave the button visible */ });
    });
  </script>
</body>
</html>
