<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AR.js — HIRO (Camera + Seam Fix)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>

  <style>
    html, body { margin:0; height:100%; width:100%; overflow:hidden; background:#000; font-family:system-ui, Arial, sans-serif; }

    /* Camera video BELOW canvas; overscan to kill right-edge line */
    video#arjs-video,
    video.arjs-video,
    video[playsinline] {
      position: fixed !important;
      top: 0; left: -10px !important;              /* overscan */
      width: calc(100vw + 20px) !important;        /* overscan */
      height: 100vh !important;
      object-fit: cover !important;
      z-index: -2 !important;                      /* BELOW canvas */
      background: #000 !important;
      pointer-events: none !important;
      transform: none !important;
      opacity: 1 !important; visibility: visible !important; display: block !important;
    }

    /* WebGL canvas ABOVE video and transparent */
    canvas.a-canvas,
    .a-canvas canvas,
    a-scene canvas {
      position: fixed !important;
      top: 0; left: -10px !important;              /* match overscan */
      width: calc(100vw + 20px) !important;
      height: 100vh !important;
      z-index: 0 !important;                       /* ABOVE video */
      display: block !important;
      pointer-events: none !important;
      background: transparent !important;
      transform: none !important;
    }

    a-scene {
      position: fixed !important; inset: 0 !important;
      width: 100vw !important; height: 100vh !important;
      background: transparent !important;
    }

    /* Start overlay */
    #gate {
      position: fixed; inset: 0; z-index: 10;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      background: rgba(0,0,0,.88); color: #fff; padding: 24px; text-align: center;
    }
    #gate button {
      padding: 12px 22px; font-size: 18px; border-radius: 8px; border: none;
      background: #ff6b6b; color: #fff;
    }

    #status {
      position: fixed; left: 8px; bottom: 8px; z-index: 20;
      background: rgba(0,0,0,.6); color: #0f0;
      padding: 6px 8px; border-radius: 6px; font: 12px/1.3 monospace;
    }
  </style>
</head>
<body>
  <div id="gate">
    <h2>Tap Start</h2>
    <p>Allow the camera, then point at your printed <b>HIRO</b> marker.</p>
    <button id="start">Start</button>
  </div>
  <div id="status">loading…</div>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="antialias:true; alpha:true; precision:mediump"
    arjs="sourceType:webcam; facingMode:environment; detectionMode:mono; debugUIEnabled:true; patternRatio:0.5"
  >
    <!-- HIRO marker only -->
    <a-marker type="pattern" id="marker" emitevents="true"
              url="https://raw.githubusercontent.com/jeromeetienne/AR.js/master/three.js/examples/marker-training/examples/pattern-files/pattern-hiro.patt">
      <a-box id="cube" position="0 1 0" width="2" height="2" depth="2"
             material="color:#FF00FF; shader:flat" visible="false"></a-box>
      <a-plane id="pad" rotation="-90 0 0" width="2" height="2"
               material="color:#FFFFFF; shader:flat; opacity:0.85" visible="false"></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const st     = document.getElementById('status');
    const gate   = document.getElementById('gate');
    const start  = document.getElementById('start');
    const marker = document.getElementById('marker');
    const cube   = document.getElementById('cube');
    const pad    = document.getElementById('pad');

    // Force transparent clear on the renderer
    function forceTransparentClear() {
      const sceneEl = document.querySelector('a-scene');
      if (!sceneEl || !sceneEl.renderer) return false;
      try {
        sceneEl.renderer.setClearColor(0x000000, 0);
        const gl = sceneEl.renderer.getContext && sceneEl.renderer.getContext();
        if (gl && gl.clearColor) gl.clearColor(0, 0, 0, 0);
      } catch(_) {}
      return true;
    }

    // Enforce video/canvas layers
    function enforceLayers() {
      const vid = document.querySelector('video#arjs-video, video.arjs-video, video[playsinline]');
      const cvs = document.querySelector('canvas.a-canvas, .a-canvas canvas, a-scene canvas');
      const apply = el => {
        if (!el) return;
        el.style.position = 'fixed';
        el.style.top = '0px';
        el.style.left = '-10px';
        el.style.width = 'calc(100vw + 20px)';
        el.style.height = '100vh';
        el.style.objectFit = 'cover';
        el.style.transform = 'none';
      };
      if (vid) {
        apply(vid);
        vid.style.zIndex = '-2';
        vid.style.pointerEvents = 'none';
        vid.style.opacity = '1';
        vid.style.visibility = 'visible';
        vid.setAttribute('playsinline',''); vid.setAttribute('webkit-playsinline','');
        try { vid.muted = true; vid.play().catch(()=>{}); } catch(_){}
      }
      if (cvs) {
        apply(cvs);
        cvs.style.zIndex = '0';
        cvs.style.background = 'transparent';
        cvs.style.pointerEvents = 'none';
      }
    }

    // Try a few times on load
    let tries = 0;
    const tick = setInterval(() => {
      forceTransparentClear();
      enforceLayers();
      if (++tries > 60) clearInterval(tick); // ~3s
    }, 50);

    // Also fix on resize/orientation and DOM changes
    addEventListener('resize', enforceLayers);
    addEventListener('orientationchange', () => setTimeout(enforceLayers, 300));
    new MutationObserver(() => { enforceLayers(); }).observe(document.documentElement, {subtree:true, childList:true});

    // Start overlay
    start.addEventListener('click', async ()=>{
      gate.style.display = 'none';
      st.textContent = 'Starting camera…';
      forceTransparentClear();
      enforceLayers();
      setTimeout(enforceLayers, 300);
      setTimeout(enforceLayers, 1000);
    });

    // Marker events
    marker.addEventListener('markerFound', ()=>{
      cube.setAttribute('visible','true');
      pad.setAttribute('visible','true');
      st.textContent = 'HIRO FOUND ✅';
    });
    marker.addEventListener('markerLost', ()=>{
      cube.setAttribute('visible','false');
      pad.setAttribute('visible','false');
      st.textContent = 'Point at the printed HIRO…';
    });
  </script>
</body>
</html>
